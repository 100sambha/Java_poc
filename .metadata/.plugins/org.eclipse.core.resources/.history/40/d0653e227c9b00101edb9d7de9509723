import java.net.URI;
import java.net.http.*;
import java.time.Duration;
import com.fasterxml.jackson.databind.*;
import com.fasterxml.jackson.databind.node.*;
import java.io.IOException;

public class App {

    private static final String API = "https://api.linkedin.com/v2/invitations";
    private final HttpClient http;
    private final ObjectMapper mapper;
    private final String accessToken;

    public App(String accessToken) {
        this.accessToken = accessToken;
        this.http = HttpClient.newBuilder()
                .connectTimeout(Duration.ofSeconds(10))
                .build();
        this.mapper = new ObjectMapper();
    }

    public void fetchAllSentInvitations() throws IOException, InterruptedException {
        int start = 0;
        final int count = 50; // adjust per-call page size
        boolean more = true;

        while (more) {
            String url = String.format("%s?q=inviter&start=%d&count=%d", API, start, count);
            HttpRequest req = HttpRequest.newBuilder()
                    .GET()
                    .uri(URI.create(url))
                    .header("Authorization", "Bearer " + accessToken)
                    .header("X-Restli-Protocol-Version", "2.0.0")
                    .header("Accept", "application/json")
                    .build();

            HttpResponse<String> resp = http.send(req, HttpResponse.BodyHandlers.ofString());
            int status = resp.statusCode();

            if (status == 200) {
                JsonNode root = mapper.readTree(resp.body());
                JsonNode elements = root.get("elements");
                if (elements == null || !elements.isArray() || elements.size() == 0) {
                    System.out.println("No more invitations.");
                    break;
                }

                // Process each invitation element
                for (JsonNode inv : elements) {
                    // Example: print invitation URN and invitee info if present
                    System.out.println(inv.toPrettyString());
                }

                // Pagination: if less than requested count returned -> end
                if (elements.size() < count) {
                    more = false;
                } else {
                    start += count;
                }
            } else {
                System.err.printf("HTTP %d: %s%n", status, resp.body());
                // If 401/403, likely auth/permissions problem â€” stop.
                break;
            }
        }
    }

    public static void main(String[] args) throws Exception {
        if (args.length < 1) {
            System.err.println("Usage: java LinkedInInvitationsFetcher <ACCESS_TOKEN>");
            System.exit(1);
        }
        String token = args[0];
        LinkedInInvitationsFetcher f = new LinkedInInvitationsFetcher(token);
        f.fetchAllSentInvitations();
    }
}
